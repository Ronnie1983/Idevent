@page "/EditUser/{UserId}"
@*@attribute [Authorize]*@

@using IdeventLibrary
@inject UserRepository _userRepository

<h1>Edit User</h1>
@if (_user != null)
{
    <h2>@_user.UserName</h2>

    <EditForm Model=@_user OnValidSubmit=@HandleValidSubmit>
        <DataAnnotationsValidator />
        <ValidationSummary />
        <div class="row">

            <div class="col-lg-6">
                <div class="form-group">
                    <label>User name</label>
                    <input class="form-control" @bind-value=@_user.UserName />
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input class="form-control" @bind-value=@_user.Email />
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input class="form-control" @bind-value=@_user.PhoneNumber />
                </div>
                @if (_user.Address != null)
                {
                    <div class="form-group">
                        <label>Address</label>
                        <input class="form-control" @bind-value=@_user.Address.StreetAddress />
                    </div>
                    <div class="form-group">
                        <label>City</label>
                        <input class="form-control" @bind-value=@_user.Address.City />
                    </div>
                    <div class="form-group">
                        <label>Country</label>
                        <input class="form-control" @bind-value=@_user.Address.Country />
                    </div>
                    <div class="form-group">
                        <label>Postal code</label>
                        <input class="form-control" @bind-value=@_user.Address.PostalCode />
                    </div>
                }
            </div>
            <div class="col-lg-6">
                <div class="form-group">
                    @if (_user.Role != null)
                    {
                        <label>Role</label>
                        <select class="form-control" value="@_user.Role" @onchange="SelectRole">
                            <option value="@Enums.Roles.SuperAdmin.ToString()">@Enums.Roles.SuperAdmin.ToString()</option>
                            <option value="@Enums.Roles.Admin.ToString()">@Enums.Roles.Admin.ToString()</option>
                            <option value="@Enums.Roles.Operator.ToString()">@Enums.Roles.Operator.ToString()</option>
                            <option value="@Enums.Roles.User.ToString()">@Enums.Roles.User.ToString()</option>
                        </select>
                    }
                </div>
            </div>
        </div>
        <button class="btn btn-primary m-1">Save</button>
        <NavigateButton HtmlClasses="btn-warning m-1" PageToNavigateTo=@Common.Helpers.NavigationArgument("Users") ButtonText="Cancel"></NavigateButton>
    </EditForm>
}
else
{
    <Loader LoadingMessage="Loading user data..." />
}


@code {
    [Parameter]
    public string UserId { get; set; }

    private UserModel _user;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _user = await _userRepository.GetUserById(UserId);
            if (_user.UserName == null) throw new NullReferenceException("UserName is null. Something went wrong when fetching user data.");
            if (_user.Address == null)
            {
                _user.Address = new AddressModel();
                _user.Address.StreetAddress = "";
                _user.Address.City = "";
                _user.Address.Country = "";
                _user.Address.PostalCode = "";
            }
            if (_user.PhoneNumber == null)
            {
                _user.PhoneNumber = "";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
    }
    private void SelectRole(ChangeEventArgs e)
    {
        _user.Role = e.Value.ToString();
    }
    private async Task HandleValidSubmit()
    {
        await _userRepository.UpdateAsync(_user);
    }
}
